# Environment variables
# PUSHBACK_TOKEN: Personal access token from Github, needs repo access: https://github.com/settings/tokens
# PUSHBACK_USER_EMAIL: Email of the user profile used as autobot
# PUSHBACK_USER_NAME: Github user name used as autobot
version: 2
machine:
  timezone: Europe/Helsinki
jobs:
  build:
    docker:
      - image: circleci/golang:1.12.0-node
    steps:
      - checkout
      - run:
          name: Setup git
          command: |
            git remote add pushback https://$PUSHBACK_TOKEN@github.com/janivihervas/authproxy.git
            git config --global user.name $PUSHBACK_USER_NAME
            git config --global user.email $PUSHBACK_USER_EMAIL
      - restore_cache:
          keys:
            - v1-deps-{{ arch }}-{{ checksum "go.mod" }}
      - run:
          name: Install
          command: |
            if [[ $CIRCLE_BRANCH != "master" ]]; then
#             Replace once https://github.com/golang/lint/issues/436 is fixed
              make install-new
#              make install-update
              if [[ $(git status --porcelain) ]]; then
                git add --all
                git commit -m "AUTOMATIC BOT: Install"
              fi
            else
              make install
            fi
      - save_cache:
          key: v1-deps-{{ arch }}-{{ checksum "go.mod" }}
          paths:
            - /go/pkg/mod
      - run:
          name: make format
          command: |
            if [[ $CIRCLE_BRANCH != "master" ]]; then
              make format
              if [[ $(git status --porcelain) ]]; then
                git add --all
                git commit -m "AUTOBOT: Format"
              fi
            fi
      - run:
          name: Format Markdown
          command: |
            if [[ $CIRCLE_BRANCH != "master" ]]; then
              sudo npm install -g prettier@1.14.0 markdown-toc@1.2.0
              find . -type f -name "*.md" | parallel -k 'markdown-toc -i "{}"'
              prettier --write "**/*.md"
              if [[ $(git status --porcelain) ]]; then
                git add --all
                git commit -m "AUTOBOT: Format Markdown"
              fi
            fi
      - run:
          name: Update diagrams
          command: |
            if [[ $CIRCLE_BRANCH != "master" ]]; then
              sudo apt-get update
              sudo apt-get install -y -qq graphviz
              find . -name "*.gv" | sed 's/\.gv//' | xargs -I {} dot -Tpng -o {}.png {}.gv
              if [[ $(git status --porcelain) ]]; then
                git add --all
                git commit -m "AUTOBOT: Update diagrams"
              fi
            fi
      - run: make lint
      - run:
          name: make test-codecov
          command: |
            make test-codecov
            if [[ $(git status --porcelain) ]]; then
              git add --all
              git commit -m "AUTOBOT: Update snapshots"
            fi
#      - run: make release
      - run:
          name: Push autobot changes
          command: |
            if [[ $CIRCLE_BRANCH != "master" ]]; then
              if [[ $(git log origin/$CIRCLE_BRANCH..$CIRCLE_BRANCH) ]]; then
                echo "Pushing autobot fixes"
                git push --set-upstream pushback $CIRCLE_BRANCH
                exit 1
              fi
            fi
